[tools]
node = "22"
pnpm = "latest"

[env]
_.path = ["{{config_root}}/node_modules/.bin", "{{config_root}}/frontend/node_modules/.bin"]
QDRANT_URL = "http://localhost:6333"

# ============================================
# Development
# ============================================

[tasks.dev]
description = "Frontend with production Firebase"
run = "cd frontend && pnpm dev"

[tasks."dev:local"]
description = "Full local stack (Docker + emulators + frontend)"
run = """
docker compose up -d
firebase emulators:start --only functions,firestore,auth,storage --import=./emulator-data &
sleep 5
cd frontend && NUXT_PUBLIC_USE_EMULATORS=true pnpm dev
"""

# ============================================
# Install (cached)
# ============================================

[tasks.install]
description = "Install all dependencies"
run = "pnpm install && cd functions && npm install"
sources = ["package.json", "pnpm-lock.yaml", "functions/package.json"]
outputs = ["node_modules/.package-lock.json", "functions/node_modules/.package-lock.json"]

# ============================================
# Build
# ============================================

[tasks.build]
description = "Build all"
depends = ["build:frontend", "build:functions"]

[tasks."build:frontend"]
run = "cd frontend && pnpm build"

[tasks."build:functions"]
run = "cd functions && npm run build"

# ============================================
# Deploy
# ============================================

[tasks.deploy]
description = "Deploy all to Firebase"
run = "firebase deploy"

[tasks."deploy:functions"]
run = "cd functions && npm run build && firebase deploy --only functions"

[tasks."deploy:hosting"]
run = "firebase deploy --only hosting"

# ============================================
# Services
# ============================================

[tasks."services:up"]
description = "Start Docker services (Qdrant, Docling)"
run = "docker compose up -d"

[tasks."services:down"]
run = "docker compose down"

# ============================================
# Other
# ============================================

[tasks.test]
run = "cd frontend && pnpm test"

[tasks.clean]
run = "rm -rf frontend/.nuxt frontend/.output functions/lib"
