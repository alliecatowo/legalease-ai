rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isTeamMember(teamId) {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/teams/$(teamId)/members/$(request.auth.uid));
    }

    function isTeamAdmin(teamId) {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/teams/$(teamId)/members/$(request.auth.uid)).data.role == 'admin';
    }

    function isTeamOwner(teamId) {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/teams/$(teamId)).data.ownerId == request.auth.uid;
    }

    // Users collection - user profiles
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId);
    }

    // Teams collection - workspaces/organizations
    match /teams/{teamId} {
      allow read: if isTeamMember(teamId);
      allow create: if isAuthenticated();
      allow update: if isTeamAdmin(teamId) || isTeamOwner(teamId);
      allow delete: if isTeamOwner(teamId);

      // Team members subcollection
      match /members/{memberId} {
        allow read: if isTeamMember(teamId);
        allow create: if isTeamAdmin(teamId) || isTeamOwner(teamId);
        allow update: if isTeamAdmin(teamId) || isTeamOwner(teamId);
        allow delete: if isTeamOwner(teamId) || (isTeamAdmin(teamId) && memberId != resource.data.userId);
      }

      // Team invitations
      match /invitations/{invitationId} {
        allow read: if isTeamMember(teamId) ||
          (isAuthenticated() && resource.data.email == request.auth.token.email);
        allow create: if isTeamAdmin(teamId) || isTeamOwner(teamId);
        allow update: if isTeamAdmin(teamId) || isTeamOwner(teamId) ||
          (isAuthenticated() && resource.data.email == request.auth.token.email);
        allow delete: if isTeamAdmin(teamId) || isTeamOwner(teamId);
      }
    }

    // Cases collection - legal cases/matters
    match /cases/{caseId} {
      // Allow if user owns the case or is member of the team
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        (resource.data.teamId != null && isTeamMember(resource.data.teamId))
      );
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        (resource.data.teamId != null && isTeamMember(resource.data.teamId))
      );

      // Documents subcollection
      match /documents/{documentId} {
        allow read, write: if isAuthenticated() && (
          get(/databases/$(database)/documents/cases/$(caseId)).data.userId == request.auth.uid ||
          (get(/databases/$(database)/documents/cases/$(caseId)).data.teamId != null &&
           isTeamMember(get(/databases/$(database)/documents/cases/$(caseId)).data.teamId))
        );
      }
    }

    // Transcriptions collection
    match /transcriptions/{transcriptionId} {
      // Allow if user owns the transcription or is member of the team
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        (resource.data.teamId != null && isTeamMember(resource.data.teamId))
      );
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        (resource.data.teamId != null && isTeamMember(resource.data.teamId))
      );
      allow delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        (resource.data.teamId != null && isTeamAdmin(resource.data.teamId))
      );
    }

    // Documents collection (top-level) - for transcripts, PDFs, etc.
    match /documents/{documentId} {
      // Allow if user owns the document or is member of the team
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        (resource.data.teamId != null && isTeamMember(resource.data.teamId))
      );
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        (resource.data.teamId != null && isTeamMember(resource.data.teamId))
      );
      allow delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        (resource.data.teamId != null && isTeamAdmin(resource.data.teamId))
      );
    }
  }
}
